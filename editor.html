<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    :root {
      --primary-color: #4F46E5;
      --primary-hover: #6366F1;
      --secondary-color: #F3F4F6;
      --border-color: #E5E7EB;
      --text-primary: #111827;
      --text-secondary: #6B7280;
      --success-color: #10B981;
      --danger-color: #EF4444;
      --toolbar-bg: #FFFFFF;
      --toolbar-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: var(--text-primary);
      background: #FAFAFA;
    }
    
    .editor-wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: relative;
      background: white;
    }
    
    .toolbar-container {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--toolbar-bg);
      box-shadow: var(--toolbar-shadow);
      border-bottom: 1px solid var(--border-color);
    }
    
    .tabs {
      display: flex;
      background: #F9FAFB;
      padding: 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      position: relative;
      padding: 12px 24px;
      cursor: pointer;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      border-bottom: 2px solid transparent;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(79, 70, 229, 0.05);
    }

    .tab.active {
      color: var(--primary-color);
      background: white;
      border-bottom-color: var(--primary-color);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-color);
    }
    
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 12px;
      background: var(--toolbar-bg);
      align-items: center;
    }

    .toolbar-group {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 0 8px;
      border-radius: 8px;
      background: #F9FAFB;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .toolbar-group:hover {
      background: #F3F4F6;
      border-color: var(--border-color);
    }

    .toolbar button {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      padding: 0;
      border: none;
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
    }

    .toolbar button:hover {
      background: white;
      color: var(--primary-color);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .toolbar button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .toolbar button.active {
      background: var(--primary-color);
      color: white;
    }

    .toolbar button svg {
      width: 20px;
      height: 20px;
      stroke-width: 2;
    }

    /* Heading buttons special style */
    .heading-btn {
      width: auto !important;
      padding: 0 12px !important;
      font-weight: 600;
      font-size: 14px;
    }

    .toolbar .separator {
      width: 1px;
      height: 24px;
      background: var(--border-color);
      margin: 0 8px;
    }

    /* Tooltip */
    .toolbar button::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) scale(0.8);
      background: #1F2937;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: all 0.2s ease;
      margin-bottom: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .toolbar button::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1F2937;
      opacity: 0;
      transition: all 0.2s ease;
      margin-bottom: 2px;
    }

    .toolbar button:hover::before,
    .toolbar button:hover::after {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }
    
    .editor-content {
      flex: 1;
      overflow-y: auto;
      background: #FAFAFA;
      padding: 20px;
    }
    
    .editor-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      padding: 24px;
      min-height: 400px;
    }
    
    #visualEditor {
      min-height: 350px;
      outline: none;
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-primary);
    }
    
    #visualEditor:focus {
      outline: none;
    }

    /* Styles pour les tableaux dans l'éditeur */
    #visualEditor table {
      border-collapse: collapse;
      margin: 16px 0;
      width: 100%;
      position: relative;
    }
    
    #visualEditor table td,
    #visualEditor table th {
      min-width: 60px;
      min-height: 30px;
      padding: 8px;
      border: 1px solid var(--border-color);
      position: relative;
      transition: all 0.2s ease;
    }

    #visualEditor table th {
      background: #F9FAFB;
      font-weight: 600;
    }

    /* Effet de survol pour les cellules */
    #visualEditor table td:hover,
    #visualEditor table th:hover {
      background-color: rgba(79, 70, 229, 0.05);
      outline: 2px solid rgba(79, 70, 229, 0.3);
      outline-offset: -2px;
    }

    /* Cellule active/sélectionnée */
    #visualEditor table td:focus,
    #visualEditor table th:focus,
    #visualEditor table .active-cell {
      background-color: rgba(79, 70, 229, 0.1);
      outline: 2px solid var(--primary-color);
      outline-offset: -2px;
    }

    /* Boutons d'action de tableau désactivés par défaut */
    .table-action-btn {
      opacity: 0.5;
      pointer-events: none;
    }

    /* Boutons actifs quand dans un tableau */
    .table-tools-active .table-action-btn {
      opacity: 1;
      pointer-events: auto;
    }

    /* Indicateur de tableau sélectionné */
    .table-selected {
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
      border-radius: 4px;
    }
    
    #htmlEditor {
      width: 100%;
      min-height: 350px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
      border: none;
      outline: none;
      resize: vertical;
      background: #1F2937;
      color: #E5E7EB;
      padding: 20px;
      border-radius: 8px;
    }
    
    .table-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      z-index: 1000;
      min-width: 400px;
    }

    .table-dialog h3 {
      margin: 0 0 20px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .table-dialog .input-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .table-dialog .input-group {
      flex: 1;
    }

    .table-dialog label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .table-dialog input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .table-dialog input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Prévisualisation du tableau */
    .table-preview {
      margin: 20px 0;
      padding: 16px;
      background: #F9FAFB;
      border-radius: 8px;
      max-height: 200px;
      overflow: auto;
    }

    .table-preview table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .table-preview td,
    .table-preview th {
      border: 1px solid #E5E7EB;
      padding: 4px 8px;
      text-align: center;
    }

    .table-preview th {
      background: white;
      font-weight: 600;
    }

    .table-dialog .dialog-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      justify-content: flex-end;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
    }
    
    .actions {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
      align-items: center;
    }
    
    .save-format {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .save-format label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .save-format select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .save-format select:hover {
      border-color: var(--primary-color);
    }

    .save-format select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: white;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--secondary-color);
      color: var(--text-primary);
      border-color: #D1D5DB;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 20px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Navigation au clavier dans les tableaux */
    #visualEditor table td[contenteditable="true"],
    #visualEditor table th[contenteditable="true"] {
      cursor: text;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Navigation au clavier dans les tableaux */
    #visualEditor table td[contenteditable="true"],
    #visualEditor table th[contenteditable="true"] {
      cursor: text;
    }

    /* Message d'aide pour les tableaux */
    .table-help-message {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(31, 41, 55, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .table-tools-active .table-help-message {
      opacity: 1;
    }

    /* Tooltip étendu pour les boutons désactivés */
    .table-action-btn:not(.table-tools-active .table-action-btn)::before {
      content: "Cliquez dans un tableau pour activer" !important;
      width: auto;
      white-space: nowrap;
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Animations */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .editor-container {
      animation: slideIn 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Chargement de l'éditeur...</div>
  </div>
  
  <div id="editorApp" style="display: none;">
    <div class="editor-wrapper">
      <div class="toolbar-container">
        <div class="tabs">
          <div class="tab active" onclick="switchTab('visual', event)">Éditeur Visuel</div>
          <div class="tab" onclick="switchTab('html', event)">Code HTML</div>
        </div>
        
        <div id="visualToolbar" class="toolbar">
          <div class="toolbar-group">
            <button onclick="formatText('bold')" data-tooltip="Gras (Ctrl/Cmd+B)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
                <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
              </svg>
            </button>
            <button onclick="formatText('italic')" data-tooltip="Italique (Ctrl/Cmd+I)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="19" y1="4" x2="10" y2="4"></line>
                <line x1="14" y1="20" x2="5" y2="20"></line>
                <line x1="15" y1="4" x2="9" y2="20"></line>
              </svg>
            </button>
            <button onclick="formatText('underline')" data-tooltip="Souligné (Ctrl/Cmd+U)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path>
                <line x1="4" y1="21" x2="20" y2="21"></line>
              </svg>
            </button>
          </div>

          <div class="separator"></div>

          <div class="toolbar-group">
            <button class="heading-btn" onclick="formatText('formatBlock', 'h1')" data-tooltip="Titre 1">H1</button>
            <button class="heading-btn" onclick="formatText('formatBlock', 'h2')" data-tooltip="Titre 2">H2</button>
            <button class="heading-btn" onclick="formatText('formatBlock', 'h3')" data-tooltip="Titre 3">H3</button>
            <button class="heading-btn" onclick="formatText('formatBlock', 'p')" data-tooltip="Paragraphe">¶</button>
          </div>

          <div class="separator"></div>

          <div class="toolbar-group">
            <button onclick="formatText('insertUnorderedList')" data-tooltip="Liste à puces">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
            </button>
            <button onclick="formatText('insertOrderedList')" data-tooltip="Liste numérotée">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="10" y1="6" x2="21" y2="6"></line>
                <line x1="10" y1="12" x2="21" y2="12"></line>
                <line x1="10" y1="18" x2="21" y2="18"></line>
                <path d="M4 6h1v4"></path>
                <path d="M4 10h2"></path>
                <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path>
              </svg>
            </button>
          </div>

          <div class="separator"></div>

          <div class="toolbar-group">
            <button onclick="formatText('createLink')" data-tooltip="Insérer un lien">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
              </svg>
            </button>
            <button onclick="formatText('unlink')" data-tooltip="Supprimer le lien">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="m18.84 12.25 1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"></path>
                <path d="m5.17 11.75-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"></path>
                <line x1="8" y1="2" x2="8" y2="5"></line>
                <line x1="2" y1="8" x2="5" y2="8"></line>
                <line x1="16" y1="19" x2="16" y2="22"></line>
                <line x1="19" y1="16" x2="22" y2="16"></line>
              </svg>
            </button>
          </div>

          <div class="separator"></div>

          <div class="toolbar-group" id="tableTools">
            <button onclick="showTableDialog()" data-tooltip="Insérer un tableau">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="3" y1="15" x2="21" y2="15"></line>
                <line x1="9" y1="3" x2="9" y2="21"></line>
                <line x1="15" y1="3" x2="15" y2="21"></line>
              </svg>
            </button>
            <button onclick="addTableRow()" data-tooltip="Ajouter une ligne" class="table-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="15" x2="21" y2="15"></line>
                <path d="M12 15v6m-3-3h6"></path>
              </svg>
            </button>
            <button onclick="addTableColumn()" data-tooltip="Ajouter une colonne" class="table-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="15" y1="3" x2="15" y2="21"></line>
                <path d="M15 12h6m-3-3v6"></path>
              </svg>
            </button>
            <button onclick="deleteTableRow()" data-tooltip="Supprimer la ligne" class="table-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="15" x2="21" y2="15"></line>
                <line x1="9" y1="15" x2="15" y2="15" stroke-width="3"></line>
              </svg>
            </button>
            <button onclick="deleteTableColumn()" data-tooltip="Supprimer la colonne" class="table-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="15" y1="3" x2="15" y2="21"></line>
                <line x1="15" y1="9" x2="15" y2="15" stroke-width="3"></line>
              </svg>
            </button>
            <button onclick="deleteTable()" data-tooltip="Supprimer le tableau" class="table-action-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
              </svg>
            </button>
          </div>

          <div class="separator"></div>

          <div class="toolbar-group">
            <button onclick="formatText('justifyLeft')" data-tooltip="Aligner à gauche">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="17" y1="10" x2="3" y2="10"></line>
                <line x1="21" y1="6" x2="3" y2="6"></line>
                <line x1="21" y1="14" x2="3" y2="14"></line>
                <line x1="17" y1="18" x2="3" y2="18"></line>
              </svg>
            </button>
            <button onclick="formatText('justifyCenter')" data-tooltip="Centrer">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="18" y1="10" x2="6" y2="10"></line>
                <line x1="21" y1="6" x2="3" y2="6"></line>
                <line x1="21" y1="14" x2="3" y2="14"></line>
                <line x1="18" y1="18" x2="6" y2="18"></line>
              </svg>
            </button>
            <button onclick="formatText('justifyRight')" data-tooltip="Aligner à droite">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="21" y1="10" x2="7" y2="10"></line>
                <line x1="21" y1="6" x2="3" y2="6"></line>
                <line x1="21" y1="14" x2="3" y2="14"></line>
                <line x1="21" y1="18" x2="7" y2="18"></line>
              </svg>
            </button>
          </div>

          <div class="separator"></div>

          <div class="toolbar-group">
            <button onclick="undo()" data-tooltip="Annuler (Ctrl/Cmd+Z)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="9 14 4 9 9 4"></polyline>
                <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
              </svg>
            </button>
            <button onclick="redo()" data-tooltip="Refaire (Ctrl/Cmd+Y)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="15 14 20 9 15 4"></polyline>
                <path d="M4 20v-7a4 4 0 0 1 4-4h12"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      
      <div class="editor-content">
        <div id="visualTab">
          <div class="editor-container">
            <div id="visualEditor" contenteditable="true"></div>
          </div>
        </div>
        
        <div id="htmlTab" style="display: none;">
          <div class="editor-container">
            <textarea id="htmlEditor"></textarea>
          </div>
        </div>
      </div>
      
      <div class="actions">
        <button class="btn btn-primary" onclick="saveContent()" title="Sauvegarder (Ctrl/Cmd+S)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Sauvegarder
        </button>
        <button class="btn btn-secondary" onclick="if(confirm('Êtes-vous sûr de vouloir annuler tous les changements ?')) google.script.host.close()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Annuler
        </button>
        <div class="save-format">
          <label for="saveFormat">Format de sauvegarde :</label>
          <select id="saveFormat">
            <option value="html">HTML</option>
            <option value="markdown">Markdown</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Boîte de dialogue pour créer un tableau -->
  <div id="tableDialog" style="display: none;">
    <div class="overlay" onclick="hideTableDialog()"></div>
    <div class="table-dialog">
      <h3>Créer un tableau</h3>
      <div class="input-row">
        <div class="input-group">
          <label for="tableRows">Nombre de lignes</label>
          <input type="number" id="tableRows" value="3" min="1" max="20" oninput="updateTablePreview()">
        </div>
        <div class="input-group">
          <label for="tableCols">Nombre de colonnes</label>
          <input type="number" id="tableCols" value="3" min="1" max="10" oninput="updateTablePreview()">
        </div>
      </div>
      <div class="table-preview" id="tablePreview">
        <!-- La prévisualisation sera générée ici -->
      </div>
      <div class="dialog-actions">
        <button class="btn btn-secondary" onclick="hideTableDialog()">Annuler</button>
        <button class="btn btn-primary" onclick="insertTable()">Créer le tableau</button>
      </div>
    </div>
  </div>
  
  <script>
    let currentTab = 'visual';
    let cellData = <?!= JSON.stringify(cellData) ?>;
    let undoStack = [];
    let redoStack = [];
    let maxUndoSteps = 50;
    let isExecutingCommand = false;

    // Initialisation
    window.onload = function() {
      loadContent(cellData);

      // Ajouter les écouteurs pour undo/redo
      document.addEventListener('keydown', handleKeyPress);
      
      // Ajouter un écouteur pour détecter quand on est dans un tableau
      document.getElementById('visualEditor').addEventListener('click', checkTableFocus);
      document.getElementById('visualEditor').addEventListener('keyup', checkTableFocus);
    };
    
    function handleKeyPress(e) {
      // Ctrl/Cmd + Z pour annuler
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      }
      // Ctrl/Cmd + Y ou Ctrl/Cmd + Shift + Z pour refaire
      else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
        e.preventDefault();
        redo();
      }
      // Ctrl/Cmd + S pour sauvegarder
      else if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveContent();
      }
    }
    
    function saveState() {
      if (isExecutingCommand) return;
      
      const content = document.getElementById('visualEditor').innerHTML;
      
      // Ne pas sauvegarder si c'est le même contenu que le dernier état
      if (undoStack.length > 0 && undoStack[undoStack.length - 1] === content) {
        return;
      }
      
      undoStack.push(content);
      
      // Limiter la taille de la pile
      if (undoStack.length > maxUndoSteps) {
        undoStack.shift();
      }
      
      // Vider la pile de redo car on a fait une nouvelle action
      redoStack = [];
    }
    
    function undo() {
      if (undoStack.length > 1) {
        isExecutingCommand = true;
        
        // Sauvegarder l'état actuel dans redo
        const currentState = undoStack.pop();
        redoStack.push(currentState);
        
        // Restaurer l'état précédent
        const previousState = undoStack[undoStack.length - 1];
        document.getElementById('visualEditor').innerHTML = previousState;
        
        // Synchroniser avec l'onglet Code
        if (currentTab === 'visual') {
          document.getElementById('htmlEditor').value = previousState;
        }
        
        setTimeout(() => { isExecutingCommand = false; }, 100);
      }
    }
    
    function redo() {
      if (redoStack.length > 0) {
        isExecutingCommand = true;
        
        const stateToRestore = redoStack.pop();
        undoStack.push(stateToRestore);
        document.getElementById('visualEditor').innerHTML = stateToRestore;
        
        // Synchroniser avec l'onglet Code
        if (currentTab === 'visual') {
          document.getElementById('htmlEditor').value = stateToRestore;
        }
        
        setTimeout(() => { isExecutingCommand = false; }, 100);
      }
    }
    
    function loadContent(data) {
      cellData = data;
      document.getElementById('loading').style.display = 'none';
      document.getElementById('editorApp').style.display = 'block';
      
      // Détecter le format du contenu
      const content = data.content || '';
      let detectedFormat = 'html';
      
      // Vérifier si c'est du Markdown (pas de balises HTML ou très peu)
      const htmlTagCount = (content.match(/<[^>]+>/g) || []).length;
      const markdownIndicators = [
        /^#{1,6}\s+/m,     // Titres
        /\*\*[^*]+\*\*/,   // Gras
        /\*[^*]+\*/,       // Italique
        /\[[^\]]+\]\([^)]+\)/, // Liens
        /^[-*]\s+/m,       // Listes
        /^\d+\.\s+/m,      // Listes numérotées
        /^\|.+\|$/m        // Tableaux Markdown
      ];
      
      const hasMarkdownSyntax = markdownIndicators.some(regex => regex.test(content));
      
      // Détecter spécifiquement les tableaux Markdown
      const hasMarkdownTable = /^\|(.+)\|\s*\n\s*\|((?:\s*:?-+:?\s*\|)+)\s*\n/m.test(content);
      
      if ((htmlTagCount < 3 && hasMarkdownSyntax) || hasMarkdownTable) {
        detectedFormat = 'markdown';
      }
      
      // Définir le format de sauvegarde par défaut selon le contenu détecté
      document.getElementById('saveFormat').value = detectedFormat;
      
      // Charger le contenu dans les éditeurs
      if (detectedFormat === 'markdown') {
        // Si c'est du Markdown, le convertir en HTML pour l'éditeur visuel
        const html = markdownToHtml(content);
        document.getElementById('visualEditor').innerHTML = html;
        document.getElementById('htmlEditor').value = html;
      } else {
        // Si c'est du HTML
        document.getElementById('visualEditor').innerHTML = content;
        document.getElementById('htmlEditor').value = content;
      }
      
      // Rendre les cellules des tableaux existants éditables
      makeTableCellsEditable();
      
      // Sauvegarder l'état initial
      setTimeout(() => saveState(), 100);
      
      // Ajouter les écouteurs d'événements
      const visualEditor = document.getElementById('visualEditor');
      
      // Observer les changements
      const observer = new MutationObserver(() => {
        if (!isExecutingCommand) {
          clearTimeout(window.saveStateTimeout);
          window.saveStateTimeout = setTimeout(saveState, 300);
        }
      });
      
      observer.observe(visualEditor, {
        childList: true,
        subtree: true,
        characterData: true,
        attributes: true
      });
      
      // Rendre les cellules des tableaux éditables
      makeTableCellsEditable();
      
      // Focus sur l'éditeur pour que les raccourcis fonctionnent
      visualEditor.focus();
    }
    
    function makeTableCellsEditable() {
      const tables = document.querySelectorAll('#visualEditor table');
      tables.forEach(table => {
        const cells = table.querySelectorAll('td, th');
        cells.forEach(cell => {
          cell.setAttribute('contenteditable', 'true');
        });
      });
    }
    
    function makeTableCellsEditable() {
      const tables = document.querySelectorAll('#visualEditor table');
      tables.forEach(table => {
        const cells = table.querySelectorAll('td, th');
        cells.forEach(cell => {
          cell.setAttribute('contenteditable', 'true');
        });
      });
    }
    
    function showError(error) {
      alert('Erreur: ' + error);
    }
    
    function switchTab(tab, event) {
      // Synchroniser le contenu avant de changer d'onglet
      syncContent();
      
      // Cacher tous les onglets
      document.getElementById('visualTab').style.display = 'none';
      document.getElementById('htmlTab').style.display = 'none';
      
      // Afficher l'onglet sélectionné
      document.getElementById(tab + 'Tab').style.display = 'block';
      
      // Gérer la visibilité de la toolbar
      document.getElementById('visualToolbar').style.display = tab === 'visual' ? 'flex' : 'none';
      
      // Mettre à jour les classes des onglets
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      if (event && event.target) {
        event.target.classList.add('active');
      }
      
      currentTab = tab;
    }
    
    function syncContent() {
      if (currentTab === 'visual') {
        const html = document.getElementById('visualEditor').innerHTML;
        document.getElementById('htmlEditor').value = html;
      } else if (currentTab === 'html') {
        const html = document.getElementById('htmlEditor').value;
        document.getElementById('visualEditor').innerHTML = html;
        // Rendre les cellules éditables si des tableaux ont été ajoutés via le code
        makeTableCellsEditable();
      }
    }
    
    function formatText(command, value) {
      // Toujours sauvegarder l'état avant toute modification
      if (currentTab === 'visual' && !isExecutingCommand) {
        saveState();
      }
      
      if (command === 'createLink') {
        value = prompt('Entrez l\'URL:');
        if (!value) return;
      }
      
      isExecutingCommand = true;
      document.execCommand(command, false, value);
      
      // Forcer la sauvegarde de l'état après l'action
      setTimeout(() => {
        isExecutingCommand = false;
        if (currentTab === 'visual') {
          saveState();
        }
      }, 50);
    }
    
    function updateMarkdown() {
      // Fonction gardée pour compatibilité mais ne fait plus rien
      // car l'onglet Markdown a été supprimé
    }
    
    function htmlToMarkdown(html) {
      // Conversion HTML vers Markdown
      // Si aucun tag HTML n'est présent, retourner rapidement le texte
      if (!/<[a-z][\s\S]*>/i.test(html)) {
        return html.replace(/\n{2,}/g, '\n').trim();
      }

      let md = html;
      
      // Remplacer les entités HTML courantes
      md = md.replace(/&nbsp;/g, ' ');
      md = md.replace(/&amp;/g, '&');
      md = md.replace(/&lt;/g, '<');
      md = md.replace(/&gt;/g, '>');
      
      // Convertir les tableaux en Markdown uniquement si des tableaux sont présents
      if (md.includes('<table')) {
        md = md.replace(/<table[^>]*>([\s\S]*?)<\/table>/gi, function(match, tableContent) {
          let markdownTable = '\n\n';
          let headers = [];
          let rows = [];
        
        // Extraire les en-têtes
        const headerMatch = tableContent.match(/<thead[^>]*>([\s\S]*?)<\/thead>/i);
        if (headerMatch) {
          const headerRows = headerMatch[1].match(/<tr[^>]*>([\s\S]*?)<\/tr>/gi);
          if (headerRows && headerRows[0]) {
            headers = headerRows[0].match(/<t[hd][^>]*>([\s\S]*?)<\/t[hd]>/gi) || [];
            headers = headers.map(h => h.replace(/<[^>]+>/g, '').trim());
          }
        }
        
        // Si pas d'en-têtes dans thead, chercher dans le premier tr
        if (headers.length === 0) {
          const firstRow = tableContent.match(/<tr[^>]*>([\s\S]*?)<\/tr>/i);
          if (firstRow) {
            const firstRowCells = firstRow[1].match(/<t[hd][^>]*>([\s\S]*?)<\/t[hd]>/gi) || [];
            if (firstRowCells.length > 0) {
              headers = firstRowCells.map(h => h.replace(/<[^>]+>/g, '').trim());
              // Enlever cette ligne du contenu pour ne pas la dupliquer
              tableContent = tableContent.replace(firstRow[0], '');
            }
          }
        }
        
        // Extraire les lignes du corps
        const bodyMatch = tableContent.match(/<tbody[^>]*>([\s\S]*?)<\/tbody>/i);
        const contentToProcess = bodyMatch ? bodyMatch[1] : tableContent;
        const bodyRows = contentToProcess.match(/<tr[^>]*>([\s\S]*?)<\/tr>/gi) || [];
        
        bodyRows.forEach(row => {
          const cells = row.match(/<t[hd][^>]*>([\s\S]*?)<\/t[hd]>/gi) || [];
          const rowData = cells.map(cell => cell.replace(/<[^>]+>/g, '').trim());
          if (rowData.length > 0) {
            rows.push(rowData);
          }
        });
        
        // Si on n'a pas d'en-têtes mais des lignes, utiliser la première ligne comme en-têtes
        if (headers.length === 0 && rows.length > 0) {
          headers = rows.shift();
        }
        
        // Construire le tableau Markdown
        if (headers.length > 0) {
          // Ligne d'en-têtes
          markdownTable += '| ' + headers.join(' | ') + ' |\n';
          
          // Ligne de séparation
          markdownTable += '|' + headers.map(() => ' --- ').join('|') + '|\n';
          
          // Lignes de données
          rows.forEach(row => {
            // S'assurer que la ligne a le même nombre de colonnes que les en-têtes
            while (row.length < headers.length) {
              row.push('');
            }
            markdownTable += '| ' + row.slice(0, headers.length).join(' | ') + ' |\n';
          });
        }
        
          return markdownTable + '\n';
        });
      }
      
      // Titres
      md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
      md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
      md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
      md = md.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n');
      md = md.replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n');
      md = md.replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n');
      
      // Gras et italique
      md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
      md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
      md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
      md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
      
      // Soulignement (pas de support natif en Markdown, on garde le HTML)
      md = md.replace(/<u[^>]*>(.*?)<\/u>/gi, '<u>$1</u>');
      
      // Liens
      md = md.replace(/<a[^>]+href=["']([^"']*?)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)');
      
      // Images
      md = md.replace(/<img[^>]+src=["']([^"']*?)["'][^>]*alt=["']([^"']*?)["'][^>]*>/gi, '![$2]($1)');
      md = md.replace(/<img[^>]+src=["']([^"']*?)["'][^>]*>/gi, '![]($1)');
      
      // Listes
      if (md.includes('<ul')) {
        md = md.replace(/<ul[^>]*>([\s\S]*?)<\/ul>/gi, function(match, content) {
          return '\n' + content.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n').trim() + '\n';
        });
      }

      if (md.includes('<ol')) {
        let olCounter = 0;
        md = md.replace(/<ol[^>]*>([\s\S]*?)<\/ol>/gi, function(match, content) {
          olCounter = 0;
          return '\n' + content.replace(/<li[^>]*>(.*?)<\/li>/gi, function(m, item) {
            olCounter++;
            return olCounter + '. ' + item + '\n';
          }).trim() + '\n';
        });
      }
      
      // Blockquotes
      md = md.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gi, '> $1\n\n');
      
      // Code inline
      md = md.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
      
      // Pre/Code blocks
      md = md.replace(/<pre[^>]*><code[^>]*>([\s\S]*?)<\/code><\/pre>/gi, '```\n$1\n```\n\n');
      md = md.replace(/<pre[^>]*>([\s\S]*?)<\/pre>/gi, '```\n$1\n```\n\n');
      
      // Paragraphes
      md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
      
      // Sauts de ligne
      md = md.replace(/<br[^>]*>/gi, '  \n');
      
      // Nettoyer les balises restantes communes
      md = md.replace(/<\/?div[^>]*>/gi, '');
      md = md.replace(/<\/?span[^>]*>/gi, '');
      
      // Nettoyer les espaces multiples et lignes vides excessives
      md = md.replace(/\n\n\n+/g, '\n\n');
      md = md.replace(/^\n+/, '');
      md = md.replace(/\n+$/, '');
      
      return md.trim();
    }
    
    function markdownToHtml(markdown) {
      // Conversion basique Markdown vers HTML
      let html = markdown;
      
      // Conserver les balises HTML existantes si présentes
      const hasHtmlTags = /<[^>]+>/.test(markdown);
      if (hasHtmlTags && markdown.includes('<table') && markdown.includes('</table>')) {
        return markdown; // Retourner tel quel si déjà du HTML avec tableaux
      }
      
      // Titres (doit être fait avant l'échappement)
      html = html.replace(/^###### (.*?)$/gm, '<h6>$1</h6>');
      html = html.replace(/^##### (.*?)$/gm, '<h5>$1</h5>');
      html = html.replace(/^#### (.*?)$/gm, '<h4>$1</h4>');
      html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
      
      // Gras et italique (avant l'échappement)
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      
      // Liens
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
      
      // Images
      html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
      
      // Tableaux Markdown
      // Rechercher les tableaux Markdown
      const tableRegex = /\|(.+)\|\n\|([\s\S]+?)\n((?:\|.+\|\n?)+)/g;
      
      html = html.replace(tableRegex, function(match, headerLine, separatorLine, bodyLines) {
        // Parser les en-têtes
        const headers = headerLine.split('|').map(h => h.trim()).filter(h => h);
        
        // Parser les lignes du corps
        const rows = bodyLines.trim().split('\n').map(line => {
          return line.split('|').map(cell => cell.trim()).filter(cell => cell !== undefined);
        });
        
        // Construire le tableau HTML
        let table = '<table border="1" style="border-collapse: collapse; width: 100%;">\n';
        
        // En-têtes
        table += '<thead>\n<tr>\n';
        headers.forEach(header => {
          table += `<th style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">${header}</th>\n`;
        });
        table += '</tr>\n</thead>\n';
        
        // Corps
        table += '<tbody>\n';
        rows.forEach(row => {
          if (row.length > 0) {
            table += '<tr>\n';
            for (let i = 0; i < headers.length; i++) {
              const cellContent = row[i] || '';
              table += `<td style="border: 1px solid #ddd; padding: 8px;">${cellContent}</td>\n`;
            }
            table += '</tr>\n';
          }
        });
        table += '</tbody>\n</table>';
        
        return table;
      });
      
      // Listes non ordonnées
      html = html.replace(/^[-*]\s+(.+)$/gm, '<uli>$1</uli>');
      html = html.replace(/(<uli>.*<\/uli>\n?)+/g, function(match) {
        return '<ul>' + match.replace(/<uli>/g, '<li>').replace(/<\/uli>/g, '</li>') + '</ul>';
      });
      
      // Code inline
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // Blocs de code
      html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
      
      // Blockquotes
      html = html.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
      html = html.replace(/(<blockquote>.*<\/blockquote>\n?)+/g, function(match) {
        return '<blockquote>' + match.replace(/<\/?blockquote>/g, '') + '</blockquote>';
      });
      
      // Paragraphes (seulement pour le texte qui n'est pas déjà dans des balises)
      html = html.split('\n\n').map(block => {
        block = block.trim();
        if (!block) return '';
        if (block.startsWith('<')) return block;
        return '<p>' + block + '</p>';
      }).join('\n\n');
      
      // Sauts de ligne simples
      html = html.replace(/([^>])\n([^<])/g, '$1<br>$2');
      
      return html;
    }
    
    function saveContent() {
      syncContent();
      
      const format = document.getElementById('saveFormat').value;
      let content;
      
      if (format === 'markdown') {
        // Sauvegarder en Markdown
        // Convertir le HTML actuel en Markdown
        const html = document.getElementById('htmlEditor').value;
        content = htmlToMarkdown(html);
      } else {
        // Sauvegarder en HTML (par défaut)
        content = document.getElementById('htmlEditor').value;
      }
      
      // Afficher un indicateur de sauvegarde
      const saveButton = document.querySelector('.btn-primary');
      const originalHTML = saveButton.innerHTML;
      saveButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"></path><path d="M12 6v6l4 2"></path></svg> Sauvegarde...';
      saveButton.disabled = true;
      
      google.script.run
        .withSuccessHandler(function() {
          // Afficher un message de succès
          saveButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Sauvegardé !';
          saveButton.style.background = 'var(--success-color)';
          // Fermer rapidement la fenêtre après sauvegarde
          setTimeout(() => {
            google.script.host.close();
          }, 500);
        })
        .withFailureHandler(function(error) {
          showError(error);
          saveButton.innerHTML = originalHTML;
          saveButton.disabled = false;
        })
        .saveCellContent(content, cellData.row, cellData.col);
    }
    
    // Fonctions pour les tableaux
    function checkTableFocus() {
      const selection = window.getSelection();
      const tableGroup = document.getElementById('tableTools');
      
      if (selection.rangeCount > 0) {
        let node = selection.anchorNode;
        let inTable = false;
        
        // Vérifier si on est dans un tableau
        while (node && node !== document.getElementById('visualEditor')) {
          if (node.nodeName === 'TABLE' || (node.parentElement && node.parentElement.nodeName === 'TABLE')) {
            inTable = true;
            break;
          }
          node = node.parentElement;
        }
        
        // Activer/désactiver les boutons de tableau
        if (inTable) {
          tableGroup.classList.add('table-tools-active');
          // Marquer le tableau actif
          const table = getParentTable();
          if (table) {
            // Retirer la classe de tous les tableaux
            document.querySelectorAll('#visualEditor table').forEach(t => {
              t.classList.remove('table-selected');
            });
            table.classList.add('table-selected');
          }
        } else {
          tableGroup.classList.remove('table-tools-active');
          // Retirer la sélection de tous les tableaux
          document.querySelectorAll('#visualEditor table').forEach(t => {
            t.classList.remove('table-selected');
          });
        }
      }
    }

    function updateTablePreview() {
      const rows = parseInt(document.getElementById('tableRows').value) || 3;
      const cols = parseInt(document.getElementById('tableCols').value) || 3;
      const preview = document.getElementById('tablePreview');
      
      let html = '<table>';
      
      // En-tête
      html += '<tr>';
      for (let j = 0; j < cols; j++) {
        html += `<th>En-tête ${j + 1}</th>`;
      }
      html += '</tr>';
      
      // Corps
      for (let i = 0; i < rows - 1; i++) {
        html += '<tr>';
        for (let j = 0; j < cols; j++) {
          html += `<td>Cellule</td>`;
        }
        html += '</tr>';
      }
      
      html += '</table>';
      preview.innerHTML = html;
    }

    function showTableDialog() {
      document.getElementById('tableDialog').style.display = 'block';
      document.getElementById('tableRows').focus();
      updateTablePreview(); // Afficher la prévisualisation initiale
    }
    
    function hideTableDialog() {
      document.getElementById('tableDialog').style.display = 'none';
    }
    
    function insertTable() {
      if (currentTab !== 'visual') {
        alert('Veuillez passer en mode Éditeur Visuel pour insérer un tableau.');
        return;
      }
      
      // Sauvegarder l'état avant
      saveState();
      
      const rows = parseInt(document.getElementById('tableRows').value) || 3;
      const cols = parseInt(document.getElementById('tableCols').value) || 3;
      
      let html = '<table border="1" style="border-collapse: collapse; width: 100%;">';
      html += '<thead><tr>';
      for (let j = 0; j < cols; j++) {
        html += `<th contenteditable="true" style="border: 1px solid #ddd; padding: 8px; background-color: #f2f2f2;">En-tête ${j + 1}</th>`;
      }
      html += '</tr></thead><tbody>';
      
      for (let i = 0; i < rows - 1; i++) {
        html += '<tr>';
        for (let j = 0; j < cols; j++) {
          html += '<td contenteditable="true" style="border: 1px solid #ddd; padding: 8px;">Cellule</td>';
        }
        html += '</tr>';
      }
      html += '</tbody></table><p>&nbsp;</p>'; // Ajouter un espace après le tableau
      
      isExecutingCommand = true;
      
      // S'assurer que l'éditeur a le focus
      document.getElementById('visualEditor').focus();
      
      // Insérer le tableau
      document.execCommand('insertHTML', false, html);
      hideTableDialog();
      
      // Forcer la sauvegarde après et activer les outils de tableau
      setTimeout(() => {
        isExecutingCommand = false;
        saveState();
        makeTableCellsEditable();
        checkTableFocus();
      }, 50);
    }
    
    function getParentTable() {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        let node = selection.anchorNode;
        while (node && node.nodeName !== 'TABLE') {
          node = node.parentElement;
        }
        return node;
      }
      return null;
    }
    
    function getParentCell() {
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        let node = selection.anchorNode;
        while (node && node.nodeName !== 'TD' && node.nodeName !== 'TH') {
          node = node.parentElement;
        }
        return node;
      }
      return null;
    }
    
    // Toutes les fonctions de manipulation de tableaux avec sauvegarde d'état améliorée
    function addTableRow() {
      if (currentTab !== 'visual') {
        alert('Veuillez passer en mode Éditeur Visuel pour modifier le tableau.');
        return;
      }
      
      const cell = getParentCell();
      if (!cell) {
        alert('Veuillez cliquer dans une cellule du tableau pour ajouter une ligne.');
        return;
      }
      
      // Sauvegarder avant
      saveState();
      
      isExecutingCommand = true;
      const row = cell.parentElement;
      const newRow = row.cloneNode(true);
      
      // Vider le contenu des cellules mais garder le style
      const cells = newRow.querySelectorAll('td, th');
      cells.forEach((cell, index) => {
        if (cell.tagName === 'TH') {
          // Convertir les th en td pour les nouvelles lignes
          const newTd = document.createElement('td');
          newTd.style.cssText = cell.style.cssText;
          newTd.setAttribute('contenteditable', 'true');
          newTd.textContent = 'Nouvelle cellule';
          cell.parentNode.replaceChild(newTd, cell);
        } else {
          cell.textContent = 'Nouvelle cellule';
        }
      });
      
      // Ajouter après la ligne actuelle
      row.parentNode.insertBefore(newRow, row.nextSibling);
      
      // Forcer la sauvegarde après
      setTimeout(() => {
        isExecutingCommand = false;
        saveState();
        makeTableCellsEditable();
      }, 50);
    }
    
    function addTableColumn() {
      if (currentTab !== 'visual') {
        alert('Veuillez passer en mode Éditeur Visuel pour modifier le tableau.');
        return;
      }
      
      const cell = getParentCell();
      if (!cell) {
        alert('Veuillez cliquer dans une cellule du tableau pour ajouter une colonne.');
        return;
      }
      
      saveState();
      
      isExecutingCommand = true;
      const cellIndex = Array.from(cell.parentElement.children).indexOf(cell);
      const table = getParentTable();
      const rows = table.querySelectorAll('tr');
      
      rows.forEach((row, rowIndex) => {
        const cells = row.children;
        if (cellIndex < cells.length) {
          const refCell = cells[cellIndex];
          const newCell = refCell.cloneNode(true);
          newCell.setAttribute('contenteditable', 'true');
          
          // Définir le contenu approprié
          if (rowIndex === 0 && newCell.tagName === 'TH') {
            newCell.textContent = `En-tête ${cells.length + 1}`;
          } else {
            newCell.textContent = 'Nouvelle cellule';
          }
          
          // Insérer après la cellule actuelle
          refCell.parentNode.insertBefore(newCell, refCell.nextSibling);
        }
      });
      
      setTimeout(() => {
        isExecutingCommand = false;
        saveState();
        makeTableCellsEditable();
      }, 50);
    }
    
    function deleteTableRow() {
      if (currentTab !== 'visual') {
        alert('Veuillez passer en mode Éditeur Visuel pour modifier le tableau.');
        return;
      }
      
      const cell = getParentCell();
      if (!cell) {
        alert('Veuillez cliquer dans une cellule du tableau pour supprimer une ligne.');
        return;
      }
      
      const row = cell.parentElement;
      const table = getParentTable();
      const allRows = table.querySelectorAll('tr');
      
      // Ne pas supprimer s'il ne reste qu'une ligne de données (en plus de l'en-tête)
      if (allRows.length <= 2) {
        alert('Le tableau doit contenir au moins une ligne de données.');
        return;
      }
      
      // Ne pas supprimer la ligne d'en-tête
      if (row.parentElement.tagName === 'THEAD') {
        alert('Impossible de supprimer la ligne d\'en-tête.');
        return;
      }
      
      if (confirm('Êtes-vous sûr de vouloir supprimer cette ligne ?')) {
        saveState();
        isExecutingCommand = true;
        row.remove();
        setTimeout(() => {
          isExecutingCommand = false;
          saveState();
        }, 50);
      }
    }
    
    function deleteTableColumn() {
      if (currentTab !== 'visual') {
        alert('Veuillez passer en mode Éditeur Visuel pour modifier le tableau.');
        return;
      }
      
      const cell = getParentCell();
      if (!cell) {
        alert('Veuillez cliquer dans une cellule du tableau pour supprimer une colonne.');
        return;
      }
      
      const cellIndex = Array.from(cell.parentElement.children).indexOf(cell);
      const table = getParentTable();
      const rows = table.querySelectorAll('tr');
      
      // Vérifier qu'il reste au moins une colonne
      const firstRowCells = rows[0].children.length;
      if (firstRowCells <= 1) {
        alert('Le tableau doit contenir au moins une colonne.');
        return;
      }
      
      if (confirm('Êtes-vous sûr de vouloir supprimer cette colonne ?')) {
        saveState();
        isExecutingCommand = true;
        
        rows.forEach(row => {
          const cells = row.children;
          if (cellIndex < cells.length) {
            cells[cellIndex].remove();
          }
        });
        
        setTimeout(() => {
          isExecutingCommand = false;
          saveState();
        }, 50);
      }
    }
    
    function deleteTable() {
      if (currentTab !== 'visual') {
        alert('Veuillez passer en mode Éditeur Visuel pour supprimer le tableau.');
        return;
      }
      
      const table = getParentTable();
      if (!table) {
        alert('Veuillez cliquer dans un tableau pour le supprimer.');
        return;
      }
      
      if (confirm('Êtes-vous sûr de vouloir supprimer ce tableau ?')) {
        saveState();
        isExecutingCommand = true;
        table.remove();
        
        // Mettre à jour l'état des boutons
        setTimeout(() => {
          isExecutingCommand = false;
          saveState();
          checkTableFocus();
        }, 50);
      }
    }
  </script>
</body>
</html>
